name: Test Installation

on: [push, pull_request]

jobs:
    test-linux:
        runs-on: ubuntu-latest
        name: Test on Linux
        strategy:
            matrix:
                image:
                    [
                        'archlinux:latest',
                        'debian:latest',
                        'fedora:latest',
                        'ubuntu:latest',
                    ]
        container:
            image: ${{ matrix.image }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Dependencies
              run: |
                  # Determine package manager based on image name
                  case "${{ matrix.image }}" in
                      debian*|ubuntu*)
                          apt-get update
                          apt-get install -y zsh curl git gdb build-essential jq nodejs npm python3 python3-pip locales procps golang-go
                          ;;
                      fedora*)
                          dnf install -y zsh curl git gdb gcc jq nodejs npm python3 python3-pip glibc-all-langpacks procps-ng golang
                          ;;
                      archlinux*)
                          pacman -Syu --noconfirm zsh curl git gdb gcc nodejs npm jq python python-pip procps-ng go
                          ;;
                  esac

            - name: Run Install Script
              shell: bash
              run: |
                  chmod +x install.sh
                  ./install.sh

    test-macos:
        env:
            PYTHON_VERSION: 3.12
            GO_VERSION: 1.20
        runs-on: macos-12
        name: Test on macOS
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Remove conflicting files
              run: |
                  for cmd in 2to3 \
                      2to3-$PYTHON_VERSION \
                      idle3 \
                      idle3.$PYTHON_VERSION \
                      pydoc3 \
                      pydoc3.$PYTHON_VERSION \
                      python3 \
                      python3-config \
                      python3.$PYTHON_VERSION \
                      python3.$PYTHON_VERSION-config
                  do
                      rm "/usr/local/bin/$cmd" || true
                  done

            - name: Install Dependencies
              run: |
                  brew uninstall --ignore-dependencies go@$GO_VERSION || true # Uninstall existing Go installation, if any
                  brew install gcc git zsh curl jq node npm python@$PYTHON_VERSION go
                  brew link --overwrite python@$PYTHON_VERSION || true # Force link and overwrite all conflicting files
                  brew link --overwrite go || true # Force link and overwrite all conflicting files

            - name: Run Install Script
              shell: bash
              run: |
                  chmod +x install.sh
                  ./install.sh

    semantic-release:
        name: Release
        needs: [test-linux, test-macos]
        runs-on: ubuntu-latest
        permissions:
            contents: write
            issues: write
        steps:
            - uses: actions/checkout@v4
            - name: Run semantic-release
              if: github.repository == 'bartventer/dotfiles' && github.event_name == 'push'
              run: |
                  yarn global add semantic-release@17 @semantic-release/changelog @semantic-release/git
                  semantic-release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
